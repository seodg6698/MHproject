<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>신규 게시글 작성</title>
	<link rel="stylesheet" th:href="@{/board_css/freeBoardWrite.css}"/>
	 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	 
	 
</head>
<body>
	  <div class="modal-overlay"></div>
    
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">신규 게시글 작성</h2>
            <button class="close-btn" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="boardForm" method="post" action="/board/insertBoard">
            <div class="modal-body">
                <div class="form-section">
                    <h3 class="section-title">신규 게시글 등록</h3>
                    
                    <div class="form-row">
                        <label class="form-label">제목 <span class="required">*</span></label>
                        <input type="text" class="form-input" id="title" name="title" required>
                    </div>
                        <input type="hidden" class="form-input" id="creatorId" name="creatorId" 
       					th:value="${session.user != null ? session.user.userid : ''}">
					
                    <div class="form-row">
                        <label class="form-label">분류</label>
                        <select class="form-select" id="category" name="category">
                            <option value="freeTalk">자유게시판</option>
                            <option value="qna">질문과 답변</option>
                            <option value="case">경험 나누기</option>
                            <option value="discussion">토론</option>
                            <option value="msg">응원의 메시지</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <div class="editor-container">
                        <div class="editor-toolbar">
                            <div class="toolbar-group">
                                <select class="toolbar-select" id="formatSelect">
                                    <option value="div">일반 텍스트</option>
                                    <option value="h1">제목 1</option>
                                    <option value="h2">제목 2</option>
                                    <option value="h3">제목 3</option>
                                    <option value="p">단락</option>
                                </select>
                            </div>
                            
                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" id="boldBtn" title="굵게">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="italicBtn" title="기울임">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="underlineBtn" title="밑줄">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="strikeBtn" title="취소선">
                                    <i class="fas fa-strikethrough"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="colorBtn" title="글자색">
                                    <i class="fas fa-palette"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" id="alignLeftBtn" title="왼쪽 정렬">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="alignCenterBtn" title="가운데 정렬">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="alignRightBtn" title="오른쪽 정렬">
                                    <i class="fas fa-align-right"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" id="listBtn" title="목록">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="orderedListBtn" title="번호 목록">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" id="linkBtn" title="링크">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="imageBtn" title="이미지">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="tableBtn" title="표 삽입">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button type="button" class="toolbar-btn" id="undoBtn" title="실행 취소">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button type="button" class="toolbar-btn" id="redoBtn" title="다시 실행">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>

                        <div id="editor" class="editor-content" contenteditable="true" placeholder="게시글 내용을 입력하세요..."></div>
                        
                        <!-- 숨겨진 textarea (폼 제출용) -->
                        <textarea id="contents" name="contents" style="display: none;"></textarea>

                        <div class="editor-footer">
                            <span>POWERED BY Custom WYSIWYG Editor</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>

    <!-- 색상 선택기 -->
    <div id="colorPicker" class="color-picker">
        <div class="color-grid">
            <div class="color-option" style="background-color: #000000" data-color="#000000"></div>
            <div class="color-option" style="background-color: #ffffff" data-color="#ffffff"></div>
            <div class="color-option" style="background-color: #ff0000" data-color="#ff0000"></div>
            <div class="color-option" style="background-color: #00ff00" data-color="#00ff00"></div>
            <div class="color-option" style="background-color: #0000ff" data-color="#0000ff"></div>
            <div class="color-option" style="background-color: #ffff00" data-color="#ffff00"></div>
            <div class="color-option" style="background-color: #ff00ff" data-color="#ff00ff"></div>
            <div class="color-option" style="background-color: #00ffff" data-color="#00ffff"></div>
            <div class="color-option" style="background-color: #808080" data-color="#808080"></div>
            <div class="color-option" style="background-color: #800000" data-color="#800000"></div>
            <div class="color-option" style="background-color: #008000" data-color="#008000"></div>
            <div class="color-option" style="background-color: #000080" data-color="#000080"></div>
            <div class="color-option" style="background-color: #800080" data-color="#800080"></div>
            <div class="color-option" style="background-color: #808000" data-color="#808000"></div>
            <div class="color-option" style="background-color: #008080" data-color="#008080"></div>
            <div class="color-option" style="background-color: #c0c0c0" data-color="#c0c0c0"></div>
        </div>
    </div>

    <!-- 링크 입력 모달 -->
    <div id="linkModal" class="link-modal">
        <h4>링크 삽입</h4>
        <input type="text" id="linkText" placeholder="링크 텍스트">
        <input type="url" id="linkUrl" placeholder="https://example.com">
        <div class="btn-group">
            <button type="button" class="btn btn-secondary" id="linkCancelBtn">취소</button>
            <button type="button" class="btn btn-primary" id="linkOkBtn">확인</button>
        </div>
    </div>

    <script>
		
		// WYSIWYG 에디터 클래스
        class WysiwygEditor {
            constructor(editorId) {
                this.editor = document.getElementById(editorId);
                this.initializeEditor();
                this.bindEvents();
            }

            initializeEditor() {
                // 에디터 초기 설정
                this.editor.style.minHeight = '300px';
                this.editor.setAttribute('contenteditable', 'true');
            }

            bindEvents() {
                // 텍스트 포맷팅 버튼들
                document.getElementById('boldBtn').addEventListener('click', () => this.executeCommand('bold'));
                document.getElementById('italicBtn').addEventListener('click', () => this.executeCommand('italic'));
                document.getElementById('underlineBtn').addEventListener('click', () => this.executeCommand('underline'));
                document.getElementById('strikeBtn').addEventListener('click', () => this.executeCommand('strikeThrough'));

                // 정렬 버튼들
                document.getElementById('alignLeftBtn').addEventListener('click', () => this.executeCommand('justifyLeft'));
                document.getElementById('alignCenterBtn').addEventListener('click', () => this.executeCommand('justifyCenter'));
                document.getElementById('alignRightBtn').addEventListener('click', () => this.executeCommand('justifyRight'));

                // 목록 버튼들
                document.getElementById('listBtn').addEventListener('click', () => this.executeCommand('insertUnorderedList'));
                document.getElementById('orderedListBtn').addEventListener('click', () => this.executeCommand('insertOrderedList'));

                // 실행 취소/다시 실행
                document.getElementById('undoBtn').addEventListener('click', () => this.executeCommand('undo'));
                document.getElementById('redoBtn').addEventListener('click', () => this.executeCommand('redo'));

                // 포맷 선택
                document.getElementById('formatSelect').addEventListener('change', (e) => {
                    this.executeCommand('formatBlock', e.target.value);
                });

                // 색상 선택
                document.getElementById('colorBtn').addEventListener('click', (e) => this.showColorPicker(e));

                // 링크 삽입
                document.getElementById('linkBtn').addEventListener('click', () => this.showLinkModal());

                // 이미지 삽입
                document.getElementById('imageBtn').addEventListener('click', () => this.insertImage());

                // 표 삽입
                document.getElementById('tableBtn').addEventListener('click', () => this.insertTable());

                // 에디터 상태 업데이트
                this.editor.addEventListener('keyup', () => this.updateToolbarState());
                this.editor.addEventListener('mouseup', () => this.updateToolbarState());
            }

            executeCommand(command, value = null) {
                this.editor.focus();
                document.execCommand(command, false, value);
                this.updateToolbarState();
            }

            updateToolbarState() {
                // 현재 선택된 텍스트의 포맷 상태를 버튼에 반영
                const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
                commands.forEach(cmd => {
                    const btn = document.getElementById(cmd + 'Btn');
                    if (btn) {
                        if (document.queryCommandState(cmd)) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    }
                });
            }

            showColorPicker(e) {
                const colorPicker = document.getElementById('colorPicker');
                const rect = e.target.getBoundingClientRect();
                
                colorPicker.style.display = 'block';
                colorPicker.style.left = rect.left + 'px';
                colorPicker.style.top = (rect.bottom + 5) + 'px';

                // 색상 옵션 클릭 이벤트
                document.querySelectorAll('.color-option').forEach(option => {
                    option.onclick = () => {
                        this.executeCommand('foreColor', option.dataset.color);
                        colorPicker.style.display = 'none';
                    };
                });

                // 외부 클릭 시 색상 선택기 닫기
                setTimeout(() => {
                    document.addEventListener('click', function hideColorPicker(e) {
                        if (!colorPicker.contains(e.target) && e.target.id !== 'colorBtn') {
                            colorPicker.style.display = 'none';
                            document.removeEventListener('click', hideColorPicker);
                        }
                    });
                }, 0);
            }

            showLinkModal() {
                const modal = document.getElementById('linkModal');
                const selection = window.getSelection();
                const selectedText = selection.toString();

                document.getElementById('linkText').value = selectedText;
                document.getElementById('linkUrl').value = '';
                modal.style.display = 'block';

                document.getElementById('linkOkBtn').onclick = () => {
                    const text = document.getElementById('linkText').value;
                    const url = document.getElementById('linkUrl').value;
                    
                    if (url) {
                        if (selectedText) {
                            this.executeCommand('createLink', url);
                        } else {
                            this.editor.focus();
                            document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text || url}</a>`);
                        }
                    }
                    modal.style.display = 'none';
                };

                document.getElementById('linkCancelBtn').onclick = () => {
                    modal.style.display = 'none';
                };
            }

            insertImage() {
                const url = prompt('이미지 URL을 입력하세요:');
                if (url) {
                    this.executeCommand('insertHTML', `<img src="${url}" style="max-width: 100%; height: auto;" alt="이미지">`);
                }
            }

            insertTable() {
                const rows = prompt('행 수를 입력하세요:', '3');
                const cols = prompt('열 수를 입력하세요:', '3');
                
                if (rows && cols) {
                    let tableHTML = '<table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
                    
                    for (let i = 0; i < parseInt(rows); i++) {
                        tableHTML += '<tr>';
                        for (let j = 0; j < parseInt(cols); j++) {
                            tableHTML += '<td style="padding: 8px; border: 1px solid #ddd;">&nbsp;</td>';
                        }
                        tableHTML += '</tr>';
                    }
                    
                    tableHTML += '</table>';
                    this.executeCommand('insertHTML', tableHTML);
                }
            }

            getContent() {
                return this.editor.innerHTML;
            }

            setContent(content) {
                this.editor.innerHTML = content;
            }
        }

        // 에디터 초기화
        const editor = new WysiwygEditor('editor');
		
        // 툴바 버튼 클릭 이벤트
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 서식 버튼들의 토글 기능
                if (this.innerHTML.includes('fa-bold') || 
                    this.innerHTML.includes('fa-italic') || 
                    this.innerHTML.includes('fa-underline')) {
                    this.classList.toggle('active');
                }
            });
        });

      // 폼 제출 이벤트
        document.getElementById('boardForm').addEventListener('submit', function(e) {
            
            const title = document.getElementById('title').value.trim();
            const editorContent = editor.getContent().trim();
            
            // 에디터 내용을 hidden textarea에 복사 (제출 전에 먼저 복사)
            document.getElementById('contents').value = editorContent;
            
            // 유효성 검사
            if (!title) {
                e.preventDefault();
                alert('제목을 입력해주세요.');
                document.getElementById('title').focus();
                return false;
            }
            
            // 에디터 내용 검사 (HTML 태그 제거하여 순수 텍스트만 검사)
            const textContent = editor.editor.textContent || editor.editor.innerText || '';
            const cleanContent = textContent.trim();
            
            if (!cleanContent || cleanContent.length === 0) {
                e.preventDefault();
                alert('내용을 입력해주세요.');
                editor.editor.focus();
                return false;
            }
            
            // 모든 검사 통과 시 정상 제출
            console.log('제출할 내용:', editorContent); // 디버깅용
            return true;
        });
        
        

        // 닫기 버튼 이벤트
        document.querySelector('.close-btn').addEventListener('click', function() {
            if (confirm('작성 중인 내용이 있습니다. 정말 닫으시겠습니까?')) {
                location.href="/board/openBoardList"
                console.log('모달 닫기');
            }
        });

        // 취소 버튼 이벤트
        document.querySelector('.btn-secondary').addEventListener('click', function() {
            if (confirm('작성 중인 내용이 있습니다. 정말 취소하시겠습니까?')) {
                location.href="/board/openBoardList"
                document.getElementById('boardForm').reset();
            }
        });
    </script>
</body>
</html>